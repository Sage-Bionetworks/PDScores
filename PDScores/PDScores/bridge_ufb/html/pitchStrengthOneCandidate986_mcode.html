<pre class="code">
<span class="srcline"><span class="lineno"><a href="160,204" id="srcline204">204</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="160,205" id="srcline205">205</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S102T24U1255">S</span> = pitchStrengthOneCandidate( <span class="var type1" id="S103T3U1258">f</span>, <span class="var type1" id="S104T27U1259">NL</span>, <span class="var type1" id="S105T1U1260">pc</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="160,206" id="srcline206">206</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S106T0U1262">primetable</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,207" id="srcline207">207</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="160,208" id="srcline208">208</a></span><span class="line"><span class="mxinfo " id="T1:U5"><span class="var type1" id="S107T1U1265">n</span> = <span class="mxinfo " id="T1:U7">fix( <span class="mxinfo " id="T1:U8"><span class="mxinfo " id="T1:U9"><span class="mxinfo " id="T1:U10"><span class="var type1" id="S103T3U1271">f</span>(<span class="mxinfo " id="T1:U12">end</span>)</span>/<span class="var type1" id="S105T1U1274">pc</span></span> - <span class="mxinfo " id="T1:U14">0.75</span></span> )</span></span>; <span class="comment">% Number of harmonics</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,209" id="srcline209">209</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T2:U15"><span class="var type1" id="S107T1U1279">n</span>==<span class="mxinfo " id="T1:U17">0</span></span>, <span class="mxinfo " id="T24:U18"><span class="var type1" id="S102T24U1283">S</span>=<span class="mxinfo " id="T1:U20">NaN</span></span>; <span class="keyword">return</span>, <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,210" id="srcline210">210</a></span><span class="line"><span class="mxinfo " id="T3:U21"><span class="var type1" id="S111T3U1289">k</span> = <span class="mxinfo " id="T3:U23">zeros( <span class="mxinfo " id="T8:U24">size(<span class="var type1" id="S103T3U1294">f</span>)</span> )</span></span>; <span class="comment">% Kernel</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,211" id="srcline211">211</a></span><span class="line"><span class="comment">% Normalize frequency w.r.t. candidate</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,212" id="srcline212">212</a></span><span class="line"><span class="mxinfo " id="T3:U26"><span class="var type1" id="S114T3U1297">q</span> = <span class="mxinfo " id="T3:U28"><span class="var type1" id="S103T3U1299">f</span> / <span class="var type1" id="S105T1U1300">pc</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,213" id="srcline213">213</a></span><span class="line"><span class="comment">% Create kernel</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,214" id="srcline214">214</a></span><span class="line"><span class="comment">% for i = [ 1 primes(n) ]</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,215" id="srcline215">215</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="160,216" id="srcline216">216</a></span><span class="line"><span class="comment">% Coder error: "FOR loop index expressions of unknown size are only</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,217" id="srcline217">217</a></span><span class="line"><span class="comment">% supported if they are of the form A:B or A:B:C."</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,218" id="srcline218">218</a></span><span class="line"><span class="comment">%for i = primetable(primetable &lt;= n)</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,219" id="srcline219">219</a></span><span class="line"><span class="mxinfo " id="T1:U31"><span class="var type1" id="S115T1U1303">idx</span> = <span class="mxinfo " id="T1:U33">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,220" id="srcline220">220</a></span><span class="line"><span class="mxinfo " id="T1:U34"><span class="var type1" id="S116T1U1307">numPrimes</span> = <span class="mxinfo " id="T1:U36">length(<span class="var type1" id="S106T24U1310">primetable</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,221" id="srcline221">221</a></span><span class="line"><span class="mxinfo " id="T1:U38"><span class="var type1" id="S118T1U1313">i</span> = <span class="mxinfo " id="T1:U40"><span class="var type1" id="S106T24U1315">primetable</span>(<span class="mxinfo " id="T1:U42"><span class="var type1" id="S115T1U1316">idx</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,222" id="srcline222">222</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T2:U44"><span class="var type1" id="S115T1U1320">idx</span> &lt;= <span class="var type1" id="S116T1U1321">numPrimes</span></span> &amp;&amp; <span class="mxinfo " id="T2:U47"><span class="var type1" id="S118T1U1323">i</span> &lt;= <span class="var type1" id="S107T1U1324">n</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="160,223" id="srcline223">223</a></span><span class="line">    <span class="mxinfo " id="T3:U50"><span class="var type1" id="S119T3U1327">a</span> = <span class="mxinfo " id="T3:U52">abs( <span class="mxinfo " id="T3:U53"><span class="var type1" id="S114T3U1331">q</span> - <span class="var type1" id="S118T1U1332">i</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,224" id="srcline224">224</a></span><span class="line">    <span class="comment">% Peak's weigth</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,225" id="srcline225">225</a></span><span class="line">    <span class="mxinfo " id="T42:U56"><span class="var type1" id="S121T42U1335">p</span> = <span class="mxinfo " id="T42:U58"><span class="var type1" id="S119T3U1337">a</span> &lt; <span class="mxinfo " id="T1:U60">.25</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="160,226" id="srcline226">226</a></span><span class="line">    <span class="mxinfo " id="T3:U61"><span class="mxinfo " id="T3:U62"><span class="var type1" id="S111T3U1342">k</span>(<span class="var type1" id="S121T42U1343">p</span>)</span> = <span class="mxinfo " id="T3:U65">cos( <span class="mxinfo " id="T3:U66"><span class="mxinfo " id="T1:U67">2*pi</span> * <span class="mxinfo " id="T3:U68"><span class="var type1" id="S114T3U1352">q</span>(<span class="var type1" id="S121T42U1353">p</span>)</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,227" id="srcline227">227</a></span><span class="line">    <span class="comment">% Valleys' weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,228" id="srcline228">228</a></span><span class="line">    <span class="mxinfo " id="T42:U71"><span class="var type1" id="S124T42U1356">v</span> = <span class="mxinfo " id="T42:U73"><span class="mxinfo " id="T42:U74"><span class="mxinfo " id="T1:U75">.25</span> &lt; <span class="var type1" id="S119T3U1360">a</span></span> &amp; <span class="mxinfo " id="T42:U77"><span class="var type1" id="S119T3U1362">a</span> &lt; <span class="mxinfo " id="T1:U79">.75</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,229" id="srcline229">229</a></span><span class="line">    <span class="mxinfo " id="T3:U80"><span class="mxinfo " id="T3:U81"><span class="var type1" id="S111T3U1367">k</span>(<span class="var type1" id="S124T42U1368">v</span>)</span> = <span class="mxinfo " id="T3:U84"><span class="mxinfo " id="T3:U85"><span class="var type1" id="S111T3U1371">k</span>(<span class="var type1" id="S124T42U1372">v</span>)</span> + <span class="mxinfo " id="T3:U88"><span class="mxinfo " id="T3:U89">cos( <span class="mxinfo " id="T3:U90"><span class="mxinfo " id="T1:U91">2*pi</span> * <span class="mxinfo " id="T3:U92"><span class="var type1" id="S114T3U1382">q</span>(<span class="var type1" id="S124T42U1383">v</span>)</span></span> )</span> / <span class="mxinfo " id="T1:U95">2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,230" id="srcline230">230</a></span><span class="line">    <span class="mxinfo " id="T1:U96"><span class="var type1" id="S115T1U1387">idx</span> = <span class="mxinfo " id="T1:U98"><span class="var type1" id="S115T1U1389">idx</span> + <span class="mxinfo " id="T1:U100">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,231" id="srcline231">231</a></span><span class="line">    <span class="mxinfo " id="T1:U101"><span class="var type1" id="S118T1U1393">i</span> = <span class="mxinfo " id="T1:U103"><span class="var type1" id="S106T24U1395">primetable</span>(<span class="var type1" id="S115T1U1396">idx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="160,232" id="srcline232">232</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,233" id="srcline233">233</a></span><span class="line"><span class="comment">% Apply envelope</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,234" id="srcline234">234</a></span><span class="line"><span class="mxinfo " id="T3:U106"><span class="var type1" id="S111T3U1399">k</span> = <span class="mxinfo " id="T3:U108"><span class="var type1" id="S111T3U1401">k</span> .* <span class="mxinfo " id="T3:U110">sqrt( <span class="mxinfo " id="T3:U111"><span class="mxinfo " id="T1:U112">1</span>./<span class="var type1" id="S103T3U1406">f</span></span>  )</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="160,235" id="srcline235">235</a></span><span class="line"><span class="comment">% K+-normalize kernel</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,236" id="srcline236">236</a></span><span class="line"><span class="mxinfo " id="T3:U114"><span class="var type1" id="S111T3U1409">k</span> = <span class="mxinfo " id="T3:U116"><span class="var type1" id="S111T3U1411">k</span> / <span class="mxinfo " id="T1:U118">norm( <span class="mxinfo " id="T3:U119"><span class="var type1" id="S111T3U1415">k</span>(<span class="mxinfo " id="T42:U121"><span class="var type1" id="S111T3U1417">k</span>&gt;<span class="mxinfo " id="T1:U123">0</span></span>)</span> )</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="160,237" id="srcline237">237</a></span><span class="line"><span class="comment">% Compute pitch strength</span></span></span>
<span class="srcline"><span class="lineno"><a href="160,238" id="srcline238">238</a></span><span class="line"><span class="mxinfo " id="T24:U124"><span class="var type1" id="S102T24U1421">S</span> = <span class="mxinfo " id="T24:U126"><span class="mxinfo " id="T24:U127"><span class="var type1" id="S111T3U1424">k</span>'</span> * <span class="var type1" id="S104T27U1425">NL</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="160,239" id="srcline239">239</a></span><span class="line"></span></span>
</pre>
